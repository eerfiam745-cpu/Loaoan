{% extends "base.html" %}

{% block title %}Dashboard - AURA SERVER EDITION{% endblock %}

{% block content %}
<!-- Welcome Bar -->
<div class="welcome-bar">
    <h2>Welcome {{ username }}</h2>
</div>

<!-- Stats Grid -->
<div class="stats-grid">
    <div class="stat-card">
        <h3 id="balanceAmount">‚Çπ{{ "{:,}".format(user.balance) }}</h3>
        <p>Balance</p>
    </div>
    <div class="stat-card">
        <h3>{{ role }}</h3>
        <p>Level</p>
    </div>
    <div class="stat-card">
        <h3>Just now</h3>
        <p>Session</p>
    </div>
    <div class="stat-card">
        <h3 id="totalKeys">{{ stats.total_keys }}</h3>
        <p>Total Keys</p>
    </div>
    <div class="stat-card">
        <h3 id="activeKeys">{{ stats.active_keys }}</h3>
        <p>Active Keys</p>
    </div>
    <div class="stat-card">
        <h3 id="expiredKeys">{{ stats.expired_keys }}</h3>
        <p>Expired Keys</p>
    </div>
</div>

<!-- Main Content Grid -->
<div class="content-grid">
    <!-- Key Management -->
    <div class="panel-section">
        <h2>üîë Key Management</h2>
        
        <form id="keyGenerationForm">
            <div class="form-group">
                <label>Game Selection</label>
                <select id="gameSelect" name="game">
                    <option value="PUBG">PUBG</option>
                    <option value="BGMI">BGMI</option>
                    <option value="COD">Call of Duty</option>
                </select>
            </div>

            <div class="form-group">
                <label>Duration</label>
                <select id="durationSelect" name="duration">
                    {% for duration, price in settings.prices.items() %}
                    <option value="{{ duration }}">
                        {% if duration == '1' %}1 Hour{% elif duration == '24' %}1 Day{% elif duration == '168' %}7 Days{% elif duration == '720' %}30 Days{% elif duration == '2160' %}90 Days{% endif %} 
                        - {{ settings.currency }}{{ price }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label>Max Devices</label>
                <select id="deviceSelect" name="devices">
                    <option value="1">1 Device</option>
                    <option value="2">2 Devices</option>
                    <option value="5">5 Devices</option>
                </select>
            </div>

            <div class="form-group">
                <label>Key Type</label>
                <select id="keyType" name="key_type" onchange="toggleNameInput()">
                    <option value="random">Random Key</option>
                    <option value="name">Name Key</option>
                    <option value="nameRandom">Name + Random Key</option>
                </select>
            </div>

            <div class="form-group" id="nameInput" style="display: none;">
                <label>Custom Name</label>
                <input type="text" id="customName" name="custom_name" placeholder="Enter custom name">
            </div>

            <div style="text-align: center; margin: 20px 0;">
                <button type="button" class="btn btn-primary" onclick="generateKey()">üîπ Generate Keys</button>
                <button type="button" class="btn btn-warning" onclick="generateNameKey()">üî∏ Name Generate</button>
            </div>
        </form>

        <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
            <button class="btn btn-danger" onclick="deleteAllKeys()">üóëÔ∏è Delete All Keys</button>
            <button class="btn btn-danger" onclick="deleteExpiredKeys()">üóëÔ∏è Delete Expired</button>
            <button class="btn btn-danger" onclick="deleteUnusedKeys()">üóëÔ∏è Delete Unused</button>
        </div>
    </div>

    <!-- Pricing Management / Referral System -->
    <div class="panel-section">
        {% if role == 'OWNER' %}
        <h2>üí∞ Owner Panel</h2>
        
        <h3>Create Referral Code</h3>
        <button class="btn btn-primary" onclick="createReferral()" style="width: 100%; margin-bottom: 20px;">üé´ Generate Referral Code</button>
        <div id="referralResult" style="margin-bottom: 20px;"></div>

        <hr style="margin: 20px 0; border: 1px solid rgba(255,255,255,0.2);">

        <h3>Update Pricing</h3>
        <div class="form-group">
            <label>Select Duration</label>
            <select id="priceSelect">
                {% for duration in settings.prices.keys() %}
                <option value="{{ duration }}">
                    {% if duration == '1' %}1 Hour{% elif duration == '24' %}1 Day{% elif duration == '168' %}7 Days{% elif duration == '720' %}30 Days{% elif duration == '2160' %}90 Days{% endif %}
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label>New Price</label>
            <input type="number" id="newPrice" placeholder="Enter new price">
        </div>

        <button class="btn btn-primary" onclick="updatePrice()" style="width: 100%;">Update Price</button>

        <hr style="margin: 20px 0; border: 1px solid rgba(255,255,255,0.2);">

        <h3>Add Balance to User</h3>
        <div class="form-group">
            <label>Username</label>
            <input type="text" id="targetUser" placeholder="Enter username">
        </div>
        <div class="form-group">
            <label>Amount</label>
            <input type="number" id="addBalanceAmount" placeholder="Enter amount to add">
        </div>
        <button class="btn btn-info" onclick="addBalance()" style="width: 100%;">Add Balance</button>
        {% else %}
        <h2>üí∞ Reseller Panel</h2>
        <p style="text-align: center; padding: 20px;">Contact owner to add balance to your account.</p>
        {% endif %}
    </div>
</div>

<!-- Feature Management -->
<div class="panel-section">
    <h2>‚öôÔ∏è Feature Management</h2>
    
    <div class="feature-grid">
        <div class="feature-item">
            <span>ESP</span>
            <label class="toggle-switch">
                <input type="checkbox" id="espToggle" {% if settings.features.esp %}checked{% endif %} onchange="updateFeature('esp', this.checked)">
                <span class="slider"></span>
            </label>
        </div>
        
        <div class="feature-item">
            <span>Aimbot</span>
            <label class="toggle-switch">
                <input type="checkbox" id="aimbotToggle" {% if settings.features.aimbot %}checked{% endif %} onchange="updateFeature('aimbot', this.checked)">
                <span class="slider"></span>
            </label>
        </div>
        
        <div class="feature-item">
            <span>Item ESP</span>
            <label class="toggle-switch">
                <input type="checkbox" id="itemToggle" {% if settings.features.item %}checked{% endif %} onchange="updateFeature('item', this.checked)">
                <span class="slider"></span>
            </label>
        </div>
        
        <div class="feature-item">
            <span>Bullet Tracking</span>
            <label class="toggle-switch">
                <input type="checkbox" id="bulletToggle" {% if settings.features.bullet %}checked{% endif %} onchange="updateFeature('bullet', this.checked)">
                <span class="slider"></span>
            </label>
        </div>
        
        <div class="feature-item">
            <span>Memory Features</span>
            <label class="toggle-switch">
                <input type="checkbox" id="memoryToggle" {% if settings.features.memory %}checked{% endif %} onchange="updateFeature('memory', this.checked)">
                <span class="slider"></span>
            </label>
        </div>
        
        <div class="feature-item">
            <span>Maintenance Mode</span>
            <label class="toggle-switch">
                <input type="checkbox" id="maintenanceToggle" {% if settings.features.maintenance %}checked{% endif %} onchange="updateFeature('maintenance', this.checked)">
                <span class="slider"></span>
            </label>
        </div>
    </div>

    <hr style="margin: 20px 0; border: 1px solid rgba(255,255,255,0.2);">

    <h3>Mod Settings</h3>
    <div class="form-group">
        <label>Mod Name</label>
        <input type="text" id="modName" placeholder="Enter mod name" value="{{ settings.mod_settings.name }}">
    </div>

    <div class="form-group">
        <label>Mod Status</label>
        <select id="modStatus">
            <option value="active" {% if settings.mod_settings.status == 'active' %}selected{% endif %}>Active</option>
            <option value="inactive" {% if settings.mod_settings.status == 'inactive' %}selected{% endif %}>Inactive</option>
            <option value="maintenance" {% if settings.mod_settings.status == 'maintenance' %}selected{% endif %}>Maintenance</option>
        </select>
    </div>

    <button class="btn btn-primary" onclick="updateModSettings()">Update Mod Settings</button>
</div>

<!-- Keys Table -->
<div class="panel-section">
    <h2>üìã Your Keys</h2>
    
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
            <button class="btn btn-primary" onclick="loadKeys()">üîÑ Refresh</button>
            <button class="btn btn-warning" onclick="toggleKeysTable()">üëÅÔ∏è Toggle</button>
        </div>
        <input type="text" id="searchKeys" placeholder="Search keys..." style="padding: 8px; border-radius: 5px; border: none; width: 300px;" onkeyup="searchKeys()">
    </div>

    <table class="keys-table" id="keysTable">
        <thead>
            <tr>
                <th>#</th>
                <th>Game</th>
                <th>User Keys</th>
                <th>Devices</th>
                <th>Duration</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="keysTableBody">
            <!-- Keys will be loaded here -->
        </tbody>
    </table>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variables
let userKeys = [];

// Load keys on page load
$(document).ready(function() {
    loadKeys();
});

// Key management functions
function generateKey() {
    const formData = new FormData(document.getElementById('keyGenerationForm'));
    
    $.ajax({
        url: '/generate_key',
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            if (response.success) {
                showAlert(response.message, 'success');
                $('#balanceAmount').text('‚Çπ' + response.remaining_balance.toLocaleString());
                loadKeys();
                
                // Show generated key
                showAlert('Generated Key: ' + response.key, 'success');
            } else {
                showAlert(response.message, 'error');
            }
        },
        error: function() {
            showAlert('Error generating key!', 'error');
        }
    });
}

function generateNameKey() {
    $('#keyType').val('name');
    toggleNameInput();
    showAlert('Please enter custom name and generate key!', 'success');
}

function toggleNameInput() {
    const keyType = $('#keyType').val();
    if (keyType === 'name' || keyType === 'nameRandom') {
        $('#nameInput').show();
    } else {
        $('#nameInput').hide();
    }
}

function loadKeys() {
    $.ajax({
        url: '/get_keys',
        method: 'GET',
        success: function(response) {
            if (response.success) {
                userKeys = response.keys;
                renderKeysTable();
                updateKeyStats();
            }
        }
    });
}

function renderKeysTable() {
    const tbody = $('#keysTableBody');
    tbody.empty();
    
    userKeys.forEach((key, index) => {
        const statusClass = key.status === 'active' ? 'status-active' : 'status-expired';
        const expiresAt = new Date(key.expires_at);
        const now = new Date();
        const isExpired = expiresAt < now;
        
        const row = `
            <tr>
                <td>${index + 1}</td>
                <td>${key.game}</td>
                <td style="font-family: monospace; color: #4CAF50;">${key.key}</td>
                <td><span class="status-active">${key.current_devices}/${key.max_devices}</span></td>
                <td>${getDurationText(key.duration)}</td>
                <td><span class="${isExpired ? 'status-expired' : 'status-active'}">${isExpired ? 'Expired' : 'Active'}</span></td>
                <td>
                    <button class="btn btn-danger" onclick="deleteKey('${key.id}')" style="padding: 5px 10px; margin: 2px;">üóëÔ∏è Delete</button>
                </td>
            </tr>
        `;
        tbody.append(row);
    });
}

function getDurationText(hours) {
    if (hours == '1') return '1 Hour';
    if (hours == '24') return '1 Day';
    if (hours == '168') return '7 Days';
    if (hours == '720') return '30 Days';
    if (hours == '2160') return '90 Days';
    return hours + ' Hours';
}

function updateKeyStats() {
    const now = new Date();
    const activeKeys = userKeys.filter(key => new Date(key.expires_at) >= now).length;
    const expiredKeys = userKeys.filter(key => new Date(key.expires_at) < now).length;
    
    $('#totalKeys').text(userKeys.length);
    $('#activeKeys').text(activeKeys);
    $('#expiredKeys').text(expiredKeys);
}

function deleteKey(keyId) {
    if (confirm('Are you sure you want to delete this key?')) {
        $.ajax({
            url: `/delete_key/${keyId}`,
            method: 'POST',
            success: function(response) {
                if (response.success) {
                    showAlert(response.message, 'success');
                    loadKeys();
                } else {
                    showAlert(response.message, 'error');
                }
            }
        });
    }
}

function deleteAllKeys() {
    if (confirm('Are you sure you want to delete ALL keys? This cannot be undone!')) {
        $.ajax({
            url: '/delete_all_keys',
            method: 'POST',
            success: function(response) {
                if (response.success) {
                    showAlert(response.message, 'success');
                    loadKeys();
                }
            }
        });
    }
}

function deleteExpiredKeys() {
    if (confirm('Are you sure you want to delete all expired keys?')) {
        // Filter and delete expired keys
        const now = new Date();
        const expiredKeys = userKeys.filter(key => new Date(key.expires_at) < now);
        
        expiredKeys.forEach(key => {
            $.ajax({
                url: `/delete_key/${key.id}`,
                method: 'POST',
                success: function(response) {
                    // Reload after last deletion
                    if (key === expiredKeys[expiredKeys.length - 1]) {
                        showAlert(`${expiredKeys.length} expired keys deleted!`, 'success');
                        loadKeys();
                    }
                }
            });
        });
    }
}

function deleteUnusedKeys() {
    if (confirm('Are you sure you want to delete all unused keys?')) {
        const unusedKeys = userKeys.filter(key => key.current_devices === 0);
        
        unusedKeys.forEach(key => {
            $.ajax({
                url: `/delete_key/${key.id}`,
                method: 'POST',
                success: function(response) {
                    if (key === unusedKeys[unusedKeys.length - 1]) {
                        showAlert(`${unusedKeys.length} unused keys deleted!`, 'success');
                        loadKeys();
                    }
                }
            });
        });
    }
}

// Owner functions
function createReferral() {
    $.ajax({
        url: '/create_referral',
        method: 'POST',
        success: function(response) {
            if (response.success) {
                showAlert(response.message, 'success');
                $('#referralResult').html(`
                    <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px;">
                        <strong>New Referral Code:</strong><br>
                        <span style="font-family: monospace; color: #4CAF50; font-size: 1.2em;">${response.referral_code}</span><br>
                        <button class="btn btn-info" onclick="copyReferralCode('${response.referral_code}')" style="margin-top: 10px;">üìã Copy Code</button>
                    </div>
                `);
            } else {
                showAlert(response.message, 'error');
            }
        }
    });
}

function copyReferralCode(code) {
    navigator.clipboard.writeText(code).then(() => {
        showAlert('Referral code copied to clipboard!', 'success');
    });
}

function updatePrice() {
    const duration = $('#priceSelect').val();
    const price = $('#newPrice').val();
    
    if (!price) {
        showAlert('Please enter a valid price!', 'error');
        return;
    }
    
    $.ajax({
        url: '/update_settings',
        method: 'POST',
        data: {
            type: 'price',
            duration: duration,
            price: price
        },
        success: function(response) {
            if (response.success) {
                showAlert(response.message, 'success');
                location.reload(); // Reload to update pricing display
            }
        }
    });
}

function addBalance() {
    const targetUser = $('#targetUser').val();
    const amount = $('#addBalanceAmount').val();
    
    if (!targetUser || !amount) {
        showAlert('Please fill all fields!', 'error');
        return;
    }
    
    $.ajax({
        url: '/add_balance',
        method: 'POST',
        data: {
            username: targetUser,
            amount: amount
        },
        success: function(response) {
            if (response.success) {
                showAlert(response.message, 'success');
                $('#targetUser').val('');
                $('#addBalanceAmount').val('');
            } else {
                showAlert(response.message, 'error');
            }
        }
    });
}

// Feature management
function updateFeature(feature, enabled) {
    $.ajax({
        url: '/update_settings',
        method: 'POST',
        data: {
            type: 'feature',
            feature: feature,
            enabled: enabled
        },
        success: function(response) {
            if (response.success) {
                showAlert(`${feature.toUpperCase()} ${enabled ? 'enabled' : 'disabled'}!`, 'success');
            }
        }
    });
}

function updateModSettings() {
    const name = $('#modName').val();
    const status = $('#modStatus').val();
    
    $.ajax({
        url: '/update_settings',
        method: 'POST',
        data: {
            type: 'mod',
            name: name,
            status: status
        },
        success: function(response) {
            if (response.success) {
                showAlert(response.message, 'success');
            }
        }
    });
}

// Utility functions
function toggleKeysTable() {
    $('#keysTable').toggle();
}

function searchKeys() {
    const searchTerm = $('#searchKeys').val().toLowerCase();
    $('#keysTableBody tr').each(function() {
        const text = $(this).text().toLowerCase();
        if (text.includes(searchTerm)) {
            $(this).show();
        } else {
            $(this).hide();
        }
    });
}
</script>
{% endblock %}